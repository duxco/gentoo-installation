<!doctype html><html lang=en class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Gentoo installation using Measured Boot, Secure Boot, Full Disk Encryption, RAID and offering a rescue system based on customised SystemRescueCD"><meta name=author content="David Sardari"><link href=https://gentoo.duxsco.de/post-boot_configuration/ rel=canonical><link rel=icon href=../assets/images/favicon.png><meta name=generator content="mkdocs-1.4.0, mkdocs-material-8.5.2"><title>8. Post-Boot Configuration - Gentoo Linux with Measured Boot</title><link rel=stylesheet href=../assets/stylesheets/main.9f9400aa.min.css><link rel=stylesheet href=../assets/stylesheets/palette.cbb835fc.min.css><link rel=stylesheet href=../stylesheets/extra.css><script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme data-md-color-primary=none data-md-color-accent=none> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#81-systemd-configuration class=md-skip> Skip to content </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=Header> <a href=.. title="Gentoo Linux with Measured Boot" class="md-header__button md-logo" aria-label="Gentoo Linux with Measured Boot" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> Gentoo Linux with Measured Boot </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 8. Post-Boot Configuration </span> </div> </div> </div> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=Search placeholder=Search autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </label> <nav class=md-search__options aria-label=Search> <button type=reset class="md-search__icon md-icon" title=Clear aria-label=Clear tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> Initializing search </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/duxsco/gentoo-installation/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </div> <div class=md-source__repository> duxsco/gentoo-installation </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=.. title="Gentoo Linux with Measured Boot" class="md-nav__button md-logo" aria-label="Gentoo Linux with Measured Boot" data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg> </a> Gentoo Linux with Measured Boot </label> <div class=md-nav__source> <a href=https://github.com/duxsco/gentoo-installation/ title="Go to repository" class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 2A10 10 0 0 0 2 12c0 4.42 2.87 8.17 6.84 9.5.5.08.66-.23.66-.5v-1.69c-2.77.6-3.36-1.34-3.36-1.34-.46-1.16-1.11-1.47-1.11-1.47-.91-.62.07-.6.07-.6 1 .07 1.53 1.03 1.53 1.03.87 1.52 2.34 1.07 2.91.83.09-.65.35-1.09.63-1.34-2.22-.25-4.55-1.11-4.55-4.92 0-1.11.38-2 1.03-2.71-.1-.25-.45-1.29.1-2.64 0 0 .84-.27 2.75 1.02.79-.22 1.65-.33 2.5-.33.85 0 1.71.11 2.5.33 1.91-1.29 2.75-1.02 2.75-1.02.55 1.35.2 2.39.1 2.64.65.71 1.03 1.6 1.03 2.71 0 3.82-2.34 4.66-4.57 4.91.36.31.69.92.69 1.85V21c0 .27.16.59.67.5C19.14 20.16 22 16.42 22 12A10 10 0 0 0 12 2Z"/></svg> </div> <div class=md-source__repository> duxsco/gentoo-installation </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=.. class=md-nav__link> 1. Introduction </a> </li> <li class=md-nav__item> <a href=../live-cd_environment/ class=md-nav__link> 2. Live-CD Environment </a> </li> <li class=md-nav__item> <a href=../disk_setup/ class=md-nav__link> 3. Disk Setup </a> </li> <li class=md-nav__item> <a href=../rescue_system/ class=md-nav__link> 4. Rescue System </a> </li> <li class=md-nav__item> <a href=../chrooting/ class=md-nav__link> 5. Chrooting </a> </li> <li class=md-nav__item> <a href=../system_setup/ class=md-nav__link> 6. System Setup </a> </li> <li class=md-nav__item> <a href=../cleanup_and_reboot/ class=md-nav__link> 7. Cleanup And Reboot </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 8. Post-Boot Configuration <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 8. Post-Boot Configuration </a> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#81-systemd-configuration class=md-nav__link> 8.1. Systemd Configuration </a> </li> <li class=md-nav__item> <a href=#82-secure-boot-setup class=md-nav__link> 8.2. Secure Boot Setup </a> </li> <li class=md-nav__item> <a href=#83-measured-boot class=md-nav__link> 8.3. Measured Boot </a> <nav class=md-nav aria-label="8.3. Measured Boot"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#831a-systemd-cryptenroll class=md-nav__link> 8.3.1.a) systemd-cryptenroll </a> </li> <li class=md-nav__item> <a href=#831b-clevis class=md-nav__link> 8.3.1.b) clevis </a> </li> <li class=md-nav__item> <a href=#832-unified-kernel-image-rebuild class=md-nav__link> 8.3.2. Unified Kernel Image Rebuild </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#84-package-cleanup class=md-nav__link> 8.4. Package Cleanup </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../virtual_server/ class=md-nav__link> 9. Virtual Server (optional) </a> </li> <li class=md-nav__item> <a href=../selinux/ class=md-nav__link> 10. SELinux (optional) </a> </li> <li class=md-nav__item> <a href=../other_gentoo_linux_repos/ class=md-nav__link> 11. Other Gentoo Linux repos </a> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label="Table of contents"> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> Table of contents </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#81-systemd-configuration class=md-nav__link> 8.1. Systemd Configuration </a> </li> <li class=md-nav__item> <a href=#82-secure-boot-setup class=md-nav__link> 8.2. Secure Boot Setup </a> </li> <li class=md-nav__item> <a href=#83-measured-boot class=md-nav__link> 8.3. Measured Boot </a> <nav class=md-nav aria-label="8.3. Measured Boot"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#831a-systemd-cryptenroll class=md-nav__link> 8.3.1.a) systemd-cryptenroll </a> </li> <li class=md-nav__item> <a href=#831b-clevis class=md-nav__link> 8.3.1.b) clevis </a> </li> <li class=md-nav__item> <a href=#832-unified-kernel-image-rebuild class=md-nav__link> 8.3.2. Unified Kernel Image Rebuild </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#84-package-cleanup class=md-nav__link> 8.4. Package Cleanup </a> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <a href=https://github.com/duxsco/gentoo-installation/blob/main/docs/post-boot_configuration.md title="Edit this page" class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg> </a> <h1>8. Post-Boot Configuration</h1> <h2 id=81-systemd-configuration>8.1. Systemd Configuration<a class=headerlink href=#81-systemd-configuration title="Permanent link">&para;</a></h2> <p>Some configuration needs to be done <strong>after</strong> Gentoo's systemd has been started. In the previous chapter, systemd was running, but only the instance belonging to SystemRescueCD.</p> <p>Setup <a href=https://wiki.gentoo.org/wiki/Systemd#Locale>localisation</a> (copy&amp;paste one after the other):</p> <div class=highlight><pre><span></span><code><span class=c1># set your language settings</span>
<span class=nb>export</span> <span class=nv>my_lang</span><span class=o>=</span><span class=s2>&quot;de_DE.UTF-8&quot;</span>
<span class=nb>export</span> <span class=nv>my_lc_messages</span><span class=o>=</span><span class=s2>&quot;en_US.UTF-8&quot;</span> <span class=c1># I prefer English messages for easier googling around.</span>

/bin/bash -c <span class=s1>&#39;</span>
<span class=s1>localectl set-locale LANG=&quot;${my_lang}&quot; LC_COLLATE=&quot;C.UTF-8&quot; LC_MESSAGES=&quot;${my_lc_messages}&quot; &amp;&amp; \</span>
<span class=s1>localectl status &amp;&amp; \</span>
<span class=s1>env-update &amp;&amp; source /etc/profile &amp;&amp; \</span>
<span class=s1>echo -e &quot;\e[1;32mSUCCESS\e[0m&quot;</span>
<span class=s1>&#39;</span>
</code></pre></div> <p>Setup <a href=https://wiki.archlinux.org/title/systemd-timesyncd>systemd-timesyncd</a> (copy&amp;paste one after the other):</p> <div class=highlight><pre><span></span><code><span class=c1># set your timezone</span>
<span class=nb>export</span> <span class=nv>my_timezone</span><span class=o>=</span><span class=s2>&quot;Europe/Berlin&quot;</span>

<span class=c1># list of ntp servers: https://www.ntppool.org/zone/@</span>
<span class=c1># set your (fallback) ntp servers</span>
<span class=nb>export</span> <span class=nv>my_ntp_servers</span><span class=o>=</span><span class=s2>&quot;0.de.pool.ntp.org 1.de.pool.ntp.org 2.de.pool.ntp.org 3.de.pool.ntp.org&quot;</span>
<span class=nb>export</span> <span class=nv>my_fallback_ntp_servers</span><span class=o>=</span><span class=s2>&quot;0.europe.pool.ntp.org 1.europe.pool.ntp.org 2.europe.pool.ntp.org 3.europe.pool.ntp.org&quot;</span>

/bin/bash -c <span class=s1>&#39;</span>
<span class=s1>timedatectl set-timezone ${my_timezone} &amp;&amp; \</span>
<span class=s1>if grep -q -w &quot;hypervisor&quot; &lt;(grep &quot;^flags[[:space:]]*:[[:space:]]*&quot; /proc/cpuinfo); then</span>
<span class=s1>    systemctl disable systemd-timesyncd.service</span>
<span class=s1>    echo $?</span>
<span class=s1>else</span>
<span class=hll><span class=s1>    rsync -av /etc/systemd/timesyncd.conf /etc/systemd/._cfg0000_timesyncd.conf &amp;&amp; \</span>
</span><span class=s1>    sed -i -e &quot;s/#NTP=/NTP=${my_ntp_servers}/&quot; -e &quot;s/#FallbackNTP=.*/FallbackNTP=${my_fallback_ntp_servers}/&quot; /etc/systemd/._cfg0000_timesyncd.conf &amp;&amp; \</span>
<span class=s1>    timedatectl set-ntp true &amp;&amp; \</span>
<span class=s1>    echo -e &quot;\e[1;32mSUCCESS\e[0m&quot;</span>
<span class=s1>fi &amp;&amp; \</span>
<span class=s1>timedatectl &amp;&amp; \</span>
<span class=s1>echo -e &quot;\e[1;32mSUCCESS\e[0m&quot;</span>
<span class=s1>&#39;</span>
</code></pre></div> <p>Setup <a href=https://wiki.gentoo.org/wiki/Nftables>nftables</a> with <a href=https://github.com/duxsco/gentoo-installation/blob/main/bin/firewall.nft>certain firewall rules</a>:</p> <div class=highlight><pre><span></span><code>emerge net-firewall/nftables <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=hll>rsync -a /etc/conf.d/nftables /etc/conf.d/._cfg0000_nftables <span class=o>&amp;&amp;</span> <span class=se>\</span>
</span>sed -i <span class=s1>&#39;s/^SAVE_ON_STOP=&quot;yes&quot;$/SAVE_ON_STOP=&quot;no&quot;/&#39;</span> /etc/conf.d/._cfg0000_nftables <span class=o>&amp;&amp;</span> <span class=se>\</span>
/usr/local/sbin/firewall.nft <span class=o>&amp;&amp;</span> <span class=se>\</span>
nft list ruleset &gt; /var/lib/nftables/rules-save <span class=o>&amp;&amp;</span> <span class=se>\</span>
systemctl <span class=nb>enable</span> nftables-restore <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>echo</span> -e <span class=s2>&quot;\e[1;32mSUCCESS\e[0m&quot;</span>
</code></pre></div> <h2 id=82-secure-boot-setup>8.2. Secure Boot Setup<a class=headerlink href=#82-secure-boot-setup title="Permanent link">&para;</a></h2> <p>If "efi-updatevar" failed in section <a href=/system_setup/#64-secure-boot>6.4. Secure Boot</a>, you can import secure boot files the following way now.</p> <p>First, boot into the Gentoo Linux and save necessary files in "DER" format on ESP:</p> <div class=highlight><pre><span></span><code>/bin/bash -c <span class=s1>&#39;</span>
<span class=s1>(</span>
<span class=s1>! mountpoint --quiet /boot/efia &amp;&amp; \</span>
<span class=s1>mount /boot/efia || true</span>
<span class=s1>) &amp;&amp; \</span>
<span class=s1>openssl x509 -outform der -in /usr/share/secureboot/keys/db/db.pem -out /boot/efia/db.der &amp;&amp; \</span>
<span class=s1>openssl x509 -outform der -in /usr/share/secureboot/keys/KEK/KEK.pem -out /boot/efia/KEK.der &amp;&amp; \</span>
<span class=s1>openssl x509 -outform der -in /usr/share/secureboot/keys/PK/PK.pem -out /boot/efia/PK.der &amp;&amp; \</span>
<span class=s1>echo -e &quot;\e[1;32mSUCCESS\e[0m&quot;</span>
<span class=s1>&#39;</span>
</code></pre></div> <p>Reboot into "UEFI Firmware Settings" and import "db.der", "KEK.der" and "PK.der" in this order. Thereafter, enable Secure Boot. Upon successful boot with secure boot enabled, you can delete the ".der" files in <code>/boot/efia</code>.</p> <p>To check whether secure boot is enabled execute:</p> <div class=highlight><pre><span></span><code>❯ sbctl status
Installed:  ✓ sbctl is installed
Owner GUID: 4cdeb60c-d2ce-4ed9-af89-2b659c21f6e4
Setup Mode: ✓ Disabled
Secure Boot:    ✓ Enabled
</code></pre></div> <p>(Optional) To list the installed secure boot keys/certs (copy&amp;paste one after the other):</p> <div class=highlight><pre><span></span><code>emerge -at app-crypt/efitools

efi-readvar
</code></pre></div> <h2 id=83-measured-boot>8.3. Measured Boot<a class=headerlink href=#83-measured-boot title="Permanent link">&para;</a></h2> <p>You have two reasonable options for measured boot on systemd:</p> <ul> <li><strong>systemd-cryptenroll</strong>: I prefer this on <strong>local systems</strong> (e.g. laptops, desktop PCs) where I have access to TTY and can take care of (optional) pin prompts which are supported with systemd ≥251. With pins, you don't have the problem of your laptop, for example, getting stolen and auto-unlocking upon boot. Furthermore, I experienced faster boot with systemd-cryptenroll than with clevis due to the use of PBKDF2 which is safe to use with the secure keys generated by systemd-cryptenroll. And, you don't have to use the "app-crypt/clevis" package from (unofficial) <a href=https://wiki.gentoo.org/wiki/Project:GURU>guru overlay</a>.</li> <li><strong>clevis</strong>: I prefer this on remote systems, e.g. a server in colocation, where I can take care of unlock via <a href=https://github.com/latchset/clevis#pin-shamir-secret-sharing>Shamir Secret Sharing</a> which combines <a href=https://github.com/latchset/clevis#pin-tpm2>TPM 2.0</a> and <a href=https://github.com/latchset/clevis#pin-tang>Tang</a> pin (<a href=https://github.com/latchset/tang>Tang project</a>).</li> </ul> <p>Use <strong>either systemd-cryptenroll or clevis</strong> in the following.</p> <h3 id=831a-systemd-cryptenroll>8.3.1.a) systemd-cryptenroll<a class=headerlink href=#831a-systemd-cryptenroll title="Permanent link">&para;</a></h3> <p>Install "app-crypt/tpm2-tools":</p> <div class=highlight><pre><span></span><code>emerge -av tpm2-tools
</code></pre></div> <p>Add support for TPM 2.0 to dracut and systemd:</p> <div class=highlight><pre><span></span><code>sed -i <span class=s2>&quot;s/\(sys-apps\/systemd \)/\1 tpm /&quot;</span> /etc/portage/package.use/main <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>echo</span> <span class=s1>&#39;add_dracutmodules+=&quot; tpm2-tss &quot;&#39;</span> &gt;&gt; /etc/dracut.conf <span class=o>&amp;&amp;</span> <span class=se>\</span>
<span class=nb>echo</span> -e <span class=s2>&quot;\e[1;32mSUCCESS\e[0m&quot;</span>
</code></pre></div> <p>Update and make sure "sys-apps/systemd" is listed among the packages:</p> <div class=highlight><pre><span></span><code>emerge -atuDN @world
</code></pre></div> <p>Make sure that TPM 2.0 devices (should only be one) are recognised:</p> <div class=highlight><pre><span></span><code>systemd-cryptenroll --tpm2-device<span class=o>=</span>list
</code></pre></div> <p>Make sure that the PCRs you are going to use have a valid hash and don't consist of zeroes only:</p> <div class=highlight><pre><span></span><code>tpm2_pcrread sha256
</code></pre></div> <p>Create new LUKS keyslots on all swap and system partitions.</p> <div class=highlight><pre><span></span><code><span class=c1># I only use PCR7 as recommended in the first sentence after following table:</span>
<span class=c1># https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#id-1.7.3.10.2.2</span>
<span class=c1>#</span>
<span class=c1># &quot;--tpm2-with-pin=yes&quot; is optional:</span>
<span class=c1># https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#--tpm2-with-pin=BOOL</span>
<span class=c1>#</span>
systemd-cryptenroll --tpm2-device<span class=o>=</span>auto --tpm2-pcrs<span class=o>=</span><span class=m>7</span> --tpm2-with-pin<span class=o>=</span>yes /dev/sda3
systemd-cryptenroll --tpm2-device<span class=o>=</span>auto --tpm2-pcrs<span class=o>=</span><span class=m>7</span> --tpm2-with-pin<span class=o>=</span>yes /dev/sda4
systemd-cryptenroll --tpm2-device<span class=o>=</span>auto --tpm2-pcrs<span class=o>=</span><span class=m>7</span> --tpm2-with-pin<span class=o>=</span>yes /dev/sdb3
systemd-cryptenroll --tpm2-device<span class=o>=</span>auto --tpm2-pcrs<span class=o>=</span><span class=m>7</span> --tpm2-with-pin<span class=o>=</span>yes /dev/sdb4
<span class=c1># etc.</span>
</code></pre></div> <p>Reboot your system!</p> <h3 id=831b-clevis>8.3.1.b) clevis<a class=headerlink href=#831b-clevis title="Permanent link">&para;</a></h3> <p>If you don't have a DHCP server available to the new system, add <a href=https://www.systutorials.com/docs/linux/man/7-dracut.cmdline/#lbAN>the following network settings</a> to the "CMDLINE" array variable in <code>/etc/dracut.conf</code>:</p> <div class=highlight><pre><span></span><code>ip=192.168.10.2::192.168.10.1:255.255.255.0:micro:enp1s0:off
</code></pre></div> <p>Install "dev-vcs/git":</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span> <span class=s1>&#39;dev-vcs/git -webdav&#39;</span> &gt;&gt; /etc/portage/package.use/main <span class=o>&amp;&amp;</span> <span class=se>\</span>
emerge -at dev-vcs/git
</code></pre></div> <p>Install "app-crypt/clevis":</p> <div class=highlight><pre><span></span><code><span class=nb>echo</span> <span class=s2>&quot;app-crypt/clevis ~amd64</span>
<span class=s2>dev-libs/jose ~amd64</span>
<span class=s2>dev-libs/luksmeta ~amd64</span>
<span class=s2>app-crypt/tpm2-tools ~amd64&quot;</span> &gt;&gt; /etc/portage/package.accept_keywords/main <span class=o>&amp;&amp;</span> <span class=se>\</span>
emerge -at app-crypt/clevis
</code></pre></div> <p>Make sure that the PCRs you are going to use have a valid hash and don't consist of zeroes only:</p> <div class=highlight><pre><span></span><code>tpm2_pcrread sha256
</code></pre></div> <p>Bind all swap and system LUKS volumes.</p> <div class=highlight><pre><span></span><code><span class=c1># I only use PCR7 as recommended in the first sentence after following table:</span>
<span class=c1># https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#id-1.7.3.10.2.2</span>
<span class=c1>#</span>
<span class=c1># A simple tang server setup is shown at:</span>
<span class=c1># https://www.youtube.com/watch?v=y_9_iWNUBug</span>
<span class=c1>#</span>
<span class=c1># I personally use AlmaLinux as tang server.</span>
<span class=c1>#</span>
clevis luks <span class=nb>bind</span> -d /dev/sda3 sss <span class=s1>&#39;{&quot;t&quot;: 2, &quot;pins&quot;: {&quot;tpm2&quot;: {&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;7&quot;}, &quot;tang&quot;: {&quot;url&quot;: &quot;http://tang.local&quot;}}}&#39;</span>
clevis luks <span class=nb>bind</span> -d /dev/sda4 sss <span class=s1>&#39;{&quot;t&quot;: 2, &quot;pins&quot;: {&quot;tpm2&quot;: {&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;7&quot;}, &quot;tang&quot;: {&quot;url&quot;: &quot;http://tang.local&quot;}}}&#39;</span>
clevis luks <span class=nb>bind</span> -d /dev/sdb3 sss <span class=s1>&#39;{&quot;t&quot;: 2, &quot;pins&quot;: {&quot;tpm2&quot;: {&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;7&quot;}, &quot;tang&quot;: {&quot;url&quot;: &quot;http://tang.local&quot;}}}&#39;</span>
clevis luks <span class=nb>bind</span> -d /dev/sdb4 sss <span class=s1>&#39;{&quot;t&quot;: 2, &quot;pins&quot;: {&quot;tpm2&quot;: {&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;7&quot;}, &quot;tang&quot;: {&quot;url&quot;: &quot;http://tang.local&quot;}}}&#39;</span>
<span class=c1># etc.</span>
</code></pre></div> <p>Show results:</p> <div class=highlight><pre><span></span><code>clevis luks list -d /dev/sda3
clevis luks list -d /dev/sda4
clevis luks list -d /dev/sdb3
clevis luks list -d /dev/sdb4
<span class=c1># etc.</span>
</code></pre></div> <h3 id=832-unified-kernel-image-rebuild>8.3.2. Unified Kernel Image Rebuild<a class=headerlink href=#832-unified-kernel-image-rebuild title="Permanent link">&para;</a></h3> <p>Rebuild the unified kernel image to contain the changes for measured boot:</p> <div class=highlight><pre><span></span><code>emerge -at --oneshot <span class=se>\</span>
<span class=k>$(</span>qlist -eI sys-kernel/gentoo-kernel-bin &gt;/dev/null <span class=o>&amp;&amp;</span> <span class=nb>echo</span> sys-kernel/gentoo-kernel-bin<span class=k>)</span> <span class=se>\</span>
<span class=k>$(</span>qlist -eI sys-kernel/gentoo-kernel &gt;/dev/null <span class=o>&amp;&amp;</span> <span class=nb>echo</span> sys-kernel/gentoo-kernel<span class=k>)</span>
</code></pre></div> <h2 id=84-package-cleanup>8.4. Package Cleanup<a class=headerlink href=#84-package-cleanup title="Permanent link">&para;</a></h2> <p>Update packages and remove extraneous ones (copy&amp;paste one after the other):</p> <div class=highlight><pre><span></span><code>emerge -atuDN @world
emerge --depclean -a
</code></pre></div> </article> </div> </div> </main> <footer class=md-footer> <nav class="md-footer__inner md-grid" aria-label=Footer> <a href=../cleanup_and_reboot/ class="md-footer__link md-footer__link--prev" aria-label="Previous: 7. Cleanup And Reboot" rel=prev> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg> </div> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Previous </span> 7. Cleanup And Reboot </div> </div> </a> <a href=../virtual_server/ class="md-footer__link md-footer__link--next" aria-label="Next: 9. Virtual Server (optional)" rel=next> <div class=md-footer__title> <div class=md-ellipsis> <span class=md-footer__direction> Next </span> 9. Virtual Server (optional) </div> </div> <div class="md-footer__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg> </div> </a> </nav> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "..", "features": ["content.code.annotate", "navigation.instant"], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script> <script src=../assets/javascripts/bundle.39f04ddb.min.js></script> </body> </html>