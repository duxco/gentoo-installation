
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Gentoo installation using Measured Boot, Secure Boot, Full Disk Encryption, RAID and offering a rescue system based on customised SystemRescueCD">
      
      
        <meta name="author" content="David Sardari">
      
      
        <link rel="canonical" href="https://duxsco.github.io/gentoo-installation/post-boot_configuration/">
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.0, mkdocs-material-8.3.6">
    
    
      
        <title>9. Post-Boot Configuration - Gentoo Linux Installation</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.4a0965b7.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#91-systemd-configuration" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Gentoo Linux Installation" class="md-header__button md-logo" aria-label="Gentoo Linux Installation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Gentoo Linux Installation
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              9. Post-Boot Configuration
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/duxsco/gentoo-installation/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    duxsco/gentoo-installation
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Gentoo Linux Installation" class="md-nav__button md-logo" aria-label="Gentoo Linux Installation" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    Gentoo Linux Installation
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/duxsco/gentoo-installation/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.1 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    duxsco/gentoo-installation
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        1. Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../live-cd_environment/" class="md-nav__link">
        2. Live-CD Environment
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../disk_setup/" class="md-nav__link">
        3. Disk Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../rescue_system/" class="md-nav__link">
        4. Rescue System
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../chrooting/" class="md-nav__link">
        5. Chrooting
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../system_setup/" class="md-nav__link">
        6. System Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../boot_setup/" class="md-nav__link">
        7. Boot Setup
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../cleanup_and_reboot/" class="md-nav__link">
        8. Cleanup And Reboot
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          9. Post-Boot Configuration
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        9. Post-Boot Configuration
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#91-systemd-configuration" class="md-nav__link">
    9.1. Systemd Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#92-measured-boot" class="md-nav__link">
    9.2. Measured Boot
  </a>
  
    <nav class="md-nav" aria-label="9.2. Measured Boot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#921a-systemd-cryptenroll" class="md-nav__link">
    9.2.1.a) systemd-cryptenroll
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#921b-clevis" class="md-nav__link">
    9.2.1.b) clevis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922-initramfs-rebuild" class="md-nav__link">
    9.2.2. Initramfs Rebuild
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#94-package-cleanup" class="md-nav__link">
    9.4. Package Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../optional_steps/" class="md-nav__link">
        10. Optional Steps
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../other_gentoo_linux_repos/" class="md-nav__link">
        11. Other Gentoo Linux Repos
      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#91-systemd-configuration" class="md-nav__link">
    9.1. Systemd Configuration
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#92-measured-boot" class="md-nav__link">
    9.2. Measured Boot
  </a>
  
    <nav class="md-nav" aria-label="9.2. Measured Boot">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#921a-systemd-cryptenroll" class="md-nav__link">
    9.2.1.a) systemd-cryptenroll
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#921b-clevis" class="md-nav__link">
    9.2.1.b) clevis
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#922-initramfs-rebuild" class="md-nav__link">
    9.2.2. Initramfs Rebuild
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#94-package-cleanup" class="md-nav__link">
    9.4. Package Cleanup
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/duxsco/gentoo-installation/blob/main/docs/post-boot_configuration.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



  <h1>9. Post-Boot Configuration</h1>

<h2 id="91-systemd-configuration">9.1. Systemd Configuration</h2>
<p>Some configuration needs to be done after systemd has been started.</p>
<p>Do some <a href="https://wiki.gentoo.org/wiki/Systemd#Configuration">initial configuration</a> (copy&amp;paste one after the other):</p>
<pre><code class="language-bash">systemd-firstboot --prompt --setup-machine-id
systemctl --preset-mode=enable-only preset-all
</code></pre>
<p>Setup <a href="https://wiki.gentoo.org/wiki/Systemd#Locale">localisation</a>:</p>
<pre><code class="language-bash">bash -c '
localectl set-locale LANG=&quot;de_DE.UTF-8&quot; LC_COLLATE=&quot;C.UTF-8&quot; LC_MESSAGES=&quot;en_US.UTF-8&quot; &amp;&amp; \
localectl status &amp;&amp; \
env-update &amp;&amp; source /etc/profile; echo $?
'
</code></pre>
<p>Setup timedatectl:</p>
<pre><code class="language-bash">bash -c '
timedatectl set-timezone Europe/Berlin &amp;&amp; \
if ! grep -q -w &quot;hypervisor&quot; &lt;(grep &quot;^flags[[:space:]]*:[[:space:]]*&quot; /proc/cpuinfo); then
    rsync -av /etc/systemd/timesyncd.conf /etc/systemd/._cfg0000_timesyncd.conf &amp;&amp; \
    sed -i -e &quot;s/#NTP=/NTP=0.de.pool.ntp.org 1.de.pool.ntp.org 2.de.pool.ntp.org 3.de.pool.ntp.org/&quot; -e &quot;s/#FallbackNTP=.*/FallbackNTP=0.europe.pool.ntp.org 1.europe.pool.ntp.org 2.europe.pool.ntp.org 3.europe.pool.ntp.org/&quot; /etc/systemd/._cfg0000_timesyncd.conf &amp;&amp; \
    timedatectl set-ntp true
    echo $?
fi &amp;&amp; \
timedatectl; echo $?
'
</code></pre>
<p>Setup nftables:</p>
<pre><code class="language-bash">bash -c '
emerge net-firewall/nftables &amp;&amp; \
rsync -a /etc/conf.d/nftables /etc/conf.d/._cfg0000_nftables &amp;&amp; \
sed -i &quot;s/^SAVE_ON_STOP=\&quot;yes\&quot;$/SAVE_ON_STOP=\&quot;no\&quot;/&quot; /etc/conf.d/._cfg0000_nftables &amp;&amp; \
/usr/local/sbin/firewall.nft &amp;&amp; \
nft list ruleset &gt; /var/lib/nftables/rules-save &amp;&amp; \
systemctl enable nftables-restore; echo $?
'
</code></pre>
<h2 id="92-measured-boot">9.2. Measured Boot</h2>
<p>You have two options for <code>Measured Boot</code>:</p>
<ul>
<li><code>systemd-cryptenroll</code>: I prefer this on local systems where I have access to tty and can take care of (optional) pin prompts which are supported with systemd 251. With pins, you don't have the problem of your laptop, for example, getting stolen and auto-unlocking upon boot. Furthermore, I experienced faster boot with <code>systemd-cryptenroll</code> than with <code>clevis</code>, and you don't have to use the <code>app-crypt/clevis</code> package from (unofficial) <a href="https://wiki.gentoo.org/wiki/Project:GURU">guru overlay</a>.</li>
<li><code>clevis</code>: I prefer this on remote systems, e.g. a server in colocation, where I can take care of auto-unlock via TPM 2.0 and Tang pin.</li>
</ul>
<p>Use either <code>systemd-cryptenroll</code> or <code>clevis</code> in the following.</p>
<h3 id="921a-systemd-cryptenroll">9.2.1.a) systemd-cryptenroll</h3>
<p>Install <code>app-crypt/tpm2-tools</code>:</p>
<pre><code class="language-bash">echo &quot;=app-crypt/tpm2-tools-5.2-r1 ~amd64&quot; &gt;&gt; /etc/portage/package.accept_keywords/main &amp;&amp; \
emerge -av tpm2-tools
</code></pre>
<p>Add support for TPM to dracut and systemd:</p>
<pre><code class="language-bash">bash -c '
sed -i &quot;s/\(sys-apps\/systemd cryptsetup\)/\1 tpm/&quot; /etc/portage/package.use/main &amp;&amp; \
echo \'add_dracutmodules+=&quot; tpm2-tss &quot;\' &gt;&gt; /etc/dracut.conf; echo $?
'
</code></pre>
<p>Enable newer version with required bug fixes and features:</p>
<pre><code class="language-bash">echo &quot;=sys-kernel/dracut-056-r1 ~amd64
=sys-apps/systemd-251.2 ~amd64&quot; &gt;&gt; /etc/portage/package.accept_keywords/main
</code></pre>
<p>Update:</p>
<pre><code class="language-bash">emerge -atuDN @world
</code></pre>
<p>Reboot your system!</p>
<p>Make sure that TPM 2.0 devices (should only be one) are recognised:</p>
<pre><code class="language-bash">systemd-cryptenroll --tpm2-device=list
</code></pre>
<p>Make sure that the PCRs you are going to use have a valid hash and don't contain only zeroes:</p>
<pre><code class="language-bash">tpm2_pcrread sha256
</code></pre>
<p>Create new LUKS keyslots on all swap and system partitions:</p>
<pre><code class="language-bash"># Adjust PCR IDs, e.g.: --tpm2-pcrs=1+7
# Further info can be found at:
# https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#id-1.7.3.10.2.2
#
# &quot;--tpm2-with-pin=yes&quot; is optional.
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+1+2+3+4+5+6+7 --tpm2-with-pin=yes /dev/sda4
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+1+2+3+4+5+6+7 --tpm2-with-pin=yes /dev/sda5
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+1+2+3+4+5+6+7 --tpm2-with-pin=yes /dev/sdb4
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=0+1+2+3+4+5+6+7 --tpm2-with-pin=yes /dev/sdb5
# etc.
</code></pre>
<p>Remove overlay directory containing <code>app-crypt/clevis</code>:</p>
<pre><code class="language-bash">rm -rf /root/localrepo
</code></pre>
<h3 id="921b-clevis">9.2.1.b) clevis</h3>
<p>Install <code>dev-vcs/git</code>:</p>
<pre><code class="language-bash">emerge -at dev-vcs/git
</code></pre>
<p>Install <code>app-crypt/clevis</code>:</p>
<pre><code class="language-bash">emerge -1 app-eselect/eselect-repository &amp;&amp; \
eselect repository create localrepo &amp;&amp; \
sed -i '/^location[[:space:]]*=[[:space:]]*\/var\/db\/repos\/localrepo$/a auto-sync = false' /etc/portage/repos.conf/eselect-repo.conf &amp;&amp; \
rsync -a /root/localrepo /var/db/repos/ &amp;&amp; \
rm -rf /root/localrepo &amp;&amp; \
echo &quot;app-crypt/clevis ~amd64
dev-libs/jose ~amd64
dev-libs/luksmeta ~amd64
app-crypt/tpm2-tools ~amd64&quot; &gt;&gt; /etc/portage/package.accept_keywords/main &amp;&amp; \
emerge -at app-crypt/clevis
</code></pre>
<p>Make sure that the PCRs you are going to use have a valid hash and don't contain only zeroes:</p>
<pre><code class="language-bash">tpm2_pcrread sha256
</code></pre>
<p>Bind all swap and system LUKS volumes:</p>
<pre><code class="language-bash"># Adjust PCR IDs, e.g.: &quot;pcr_ids&quot;:&quot;1,7&quot;
# Further info can be found at:
# https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#id-1.7.3.10.2.2
clevis luks bind -d /dev/sda4 tpm2 '{&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;0,1,2,3,4,5,6,7&quot;}'
clevis luks bind -d /dev/sda5 tpm2 '{&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;0,1,2,3,4,5,6,7&quot;}'
clevis luks bind -d /dev/sdb4 tpm2 '{&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;0,1,2,3,4,5,6,7&quot;}'
clevis luks bind -d /dev/sdb5 tpm2 '{&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;0,1,2,3,4,5,6,7&quot;}'
# etc.
</code></pre>
<p>Show results:</p>
<pre><code class="language-bash">clevis luks list -d /dev/sda4
clevis luks list -d /dev/sda5
clevis luks list -d /dev/sdb4
clevis luks list -d /dev/sdb5
# etc.
# Sample output:
# 1: tpm2 '{&quot;hash&quot;:&quot;sha256&quot;,&quot;key&quot;:&quot;ecc&quot;,&quot;pcr_bank&quot;:&quot;sha256&quot;,&quot;pcr_ids&quot;:&quot;1,2,3,4,5,6,7&quot;}'
</code></pre>
<h3 id="922-initramfs-rebuild">9.2.2. Initramfs Rebuild</h3>
<p>Enable <a href="https://wiki.gentoo.org/wiki//etc/portage/bashrc">portage hook</a> and reinstall <code>sys-kernel/gentoo-kernel-bin</code> to integrate clevis OR systemd's TPM support in initramfs and GnuPG auto-sign <code>/boot</code> files:</p>
<pre><code class="language-bash">mv /root/bashrc /etc/portage/ &amp;&amp; \
chmod u=rw,og=r /etc/portage/bashrc &amp;&amp; \
emerge sys-kernel/gentoo-kernel-bin
</code></pre>
<p>Make sure you have:</p>
<pre><code class="language-bash">❯ ls -la /boot/
total 125628
drwx------ 1 root root      424 14. Jun 23:39 ./
drwxr-xr-x 1 root root      140 14. Jun 23:13 ../
-rw-r--r-- 1 root root  5822827 14. Jun 23:39 System.map
-rw-r--r-- 1 root root  5822827 14. Jun 22:35 System.map.old
-rw-r--r-- 1 root root      438 14. Jun 23:12 System.map.old.sig
-rw-r--r-- 1 root root      438 14. Jun 23:39 System.map.sig
-rw-r--r-- 1 root root   235283 14. Jun 23:39 config
-rw-r--r-- 1 root root   235283 14. Jun 22:35 config.old
-rw-r--r-- 1 root root      438 14. Jun 23:12 config.old.sig
-rw-r--r-- 1 root root      438 14. Jun 23:39 config.sig
-rw-r--r-- 1 root root     1390 14. Jun 23:11 grub.cfg
-rw-r--r-- 1 root root      438 14. Jun 23:12 grub.cfg.sig
-rw-r--r-- 1 root root 58616905 14. Jun 23:39 initramfs
-rw-r--r-- 1 root root 36435427 14. Jun 22:35 initramfs.old
-rw-r--r-- 1 root root      438 14. Jun 23:12 initramfs.old.sig
-rw-r--r-- 1 root root      438 14. Jun 23:39 initramfs.sig
-rw-r--r-- 1 root root 10698848 14. Jun 23:39 vmlinuz
-rw-r--r-- 1 root root 10698848 14. Jun 22:35 vmlinuz.old
-rw-r--r-- 1 root root      438 14. Jun 23:12 vmlinuz.old.sig
-rw-r--r-- 1 root root      438 14. Jun 23:39 vmlinuz.sig
</code></pre>
<p><code>.old</code> and <code>.old.sig</code> files are those of the initial package installation within chroot. <code>initramfs.old</code> doesn't have clevis and systemd's TPM support integrated.</p>
<h2 id="94-package-cleanup">9.4. Package Cleanup</h2>
<p>Remove extraneous packages (should be only <code>app-editors/nano</code>, <code>app-eselect/eselect-repository</code>, <code>app-misc/yq</code> and <code>app-portage/cpuid2cpuflags</code>):</p>
<pre><code class="language-bash">emerge --depclean -a
</code></pre>

              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href="../cleanup_and_reboot/" class="md-footer__link md-footer__link--prev" aria-label="Previous: 8. Cleanup And Reboot" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              8. Cleanup And Reboot
            </div>
          </div>
        </a>
      
      
        
        <a href="../optional_steps/" class="md-footer__link md-footer__link--next" aria-label="Next: 10. Optional Steps" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              10. Optional Steps
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.85cb4492.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.a877e258.min.js"></script>
      
    
  </body>
</html>