## 12.1. systemd Configuration

Some configuration needs to be done **after** Gentoo's systemd has been started. In the previous chapter, systemd was running, but only the instance belonging to SystemRescueCD.

Setup [localisation](https://wiki.gentoo.org/wiki/Systemd#Locale) (copy&paste one after the other):

```shell
# set your language settings
export my_lang="de_DE.UTF-8"
export my_lc_messages="en_US.UTF-8" # I prefer English messages for easier googling around.

/bin/bash -c '
localectl set-locale LANG="${my_lang}" LC_COLLATE="C.UTF-8" LC_MESSAGES="${my_lc_messages}" && \
localectl status && \
env-update && source /etc/profile && \
echo -e "\e[1;32mSUCCESS\e[0m"
'
```

Setup [systemd-timesyncd](https://wiki.archlinux.org/title/systemd-timesyncd) (copy&paste one after the other):

```shell hl_lines="15"
# set your timezone
export my_timezone="Europe/Berlin"

# list of ntp servers: https://www.ntppool.org/zone/@
# set your (fallback) ntp servers
export my_ntp_servers="0.de.pool.ntp.org 1.de.pool.ntp.org 2.de.pool.ntp.org 3.de.pool.ntp.org"
export my_fallback_ntp_servers="0.europe.pool.ntp.org 1.europe.pool.ntp.org 2.europe.pool.ntp.org 3.europe.pool.ntp.org"

/bin/bash -c '
timedatectl set-timezone ${my_timezone} && \
if grep -q -w "hypervisor" <(grep "^flags[[:space:]]*:[[:space:]]*" /proc/cpuinfo); then
    systemctl disable systemd-timesyncd.service && \
    echo -e "\e[1;32mSUCCESS\e[0m"
else
    rsync -av /etc/systemd/timesyncd.conf /etc/systemd/._cfg0000_timesyncd.conf && \
    sed -i -e "s/#NTP=/NTP=${my_ntp_servers}/" -e "s/#FallbackNTP=.*/FallbackNTP=${my_fallback_ntp_servers}/" /etc/systemd/._cfg0000_timesyncd.conf && \
    timedatectl set-ntp true && \
    echo -e "\e[1;32mSUCCESS\e[0m"
fi && \
timedatectl && \
echo -e "\e[1;32mSUCCESS\e[0m"
'
```

Setup [nftables](https://wiki.gentoo.org/wiki/Nftables) with [certain firewall rules](https://github.com/duxsco/gentoo-installation/blob/main/bin/firewall.nft):

```shell hl_lines="2"
emerge net-firewall/nftables && \
rsync -a /etc/conf.d/nftables /etc/conf.d/._cfg0000_nftables && \
sed -i 's/^SAVE_ON_STOP="yes"$/SAVE_ON_STOP="no"/' /etc/conf.d/._cfg0000_nftables && \
/usr/local/sbin/firewall.nft && \
nft list ruleset > /var/lib/nftables/rules-save && \
systemctl enable nftables-restore && \
echo -e "\e[1;32mSUCCESS\e[0m"
```

## 12.2. Secure Boot Setup

If "sbctl enroll-keys" failed in section [6.4. Secure Boot](/system_setup/#64-secure-boot), you can import secure boot files the following way now.

First, boot into the Gentoo Linux and save necessary files in "DER" format on ESP:

```shell
/bin/bash -c '
{
! mountpoint --quiet /boot/efia && \
mount /boot/efia || true
} && \
openssl x509 -outform der -in /usr/share/secureboot/keys/db/db.pem -out /boot/efia/db.der && \
openssl x509 -outform der -in /usr/share/secureboot/keys/KEK/KEK.pem -out /boot/efia/KEK.der && \
openssl x509 -outform der -in /usr/share/secureboot/keys/PK/PK.pem -out /boot/efia/PK.der && \
echo -e "\e[1;32mSUCCESS\e[0m"
'
```

Reboot into "UEFI Firmware Settings" and import "db.der", "KEK.der" and "PK.der" in this order. Thereafter, enable secure boot. Upon successful boot with secure boot enabled, you can delete the ".der" files in `/boot/efia`.

To check whether secure boot is enabled execute:

```shell
❯ sbctl status
Installed:	✓ sbctl is installed
Owner GUID:	4cdeb60c-d2ce-4ed9-af89-2b659c21f6e4
Setup Mode:	✓ Disabled
Secure Boot:	✓ Enabled
```

(Optional) To list the installed secure boot keys/certs (copy&paste one after the other):

```shell
emerge -at app-crypt/efitools

efi-readvar
```

## 12.3. Measured Boot

You have two reasonable options for measured boot on systemd:

- **systemd-cryptenroll**: I prefer this on **local systems** (e.g. laptops, desktop PCs) where I have access to TTY and can take care of (optional) pin prompts which are supported with systemd ≥251. With pins, you don't have the problem of your laptop, for example, getting stolen and auto-unlocking upon boot. Furthermore, I experienced faster boot with systemd-cryptenroll than with clevis due to the use of PBKDF2 which is safe to use with the secure keys generated by systemd-cryptenroll. And, you don't have to use the "app-crypt/clevis" package from (unofficial) [guru overlay](https://wiki.gentoo.org/wiki/Project:GURU).
- **clevis**: I prefer this on **remote systems**, e.g. a server in colocation, where I can take care of unlock via [Shamir Secret Sharing](https://github.com/latchset/clevis#pin-shamir-secret-sharing) which combines [TPM 2.0](https://github.com/latchset/clevis#pin-tpm2) and [Tang](https://github.com/latchset/clevis#pin-tang) pin ([Tang project](https://github.com/latchset/tang)).

Use **either systemd-cryptenroll or clevis** in the following.

### 12.3.1.a) systemd-cryptenroll

Install "app-crypt/tpm2-tools":

```shell
emerge -av tpm2-tools
```

Add support for TPM 2.0 to dracut and systemd:

```shell hl_lines="1"
rsync -a /etc/portage/package.use/main /etc/portage/package.use/._cfg0000_main && \
sed -i "s/\(sys-apps\/systemd \)/\1 tpm /" /etc/portage/package.use/._cfg0000_main && \
echo 'add_dracutmodules+=" tpm2-tss "' >> /etc/dracut.conf && \
echo -e "\e[1;32mSUCCESS\e[0m"
```

Update and make sure "sys-apps/systemd" is listed among the packages:

```shell
emerge -atuDN @world
```

Make sure that TPM 2.0 devices (should only be one) are recognised:

```shell
systemd-cryptenroll --tpm2-device=list
```

Make sure that the PCRs you are going to use have a valid hash and don't consist of zeroes only:

```shell
tpm2_pcrread sha256
```

Create new LUKS keyslots on all swap and system partitions.

```shell
# I only use PCR7 as recommended in the first sentence after following table:
# https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#id-1.7.3.10.2.2
#
# "--tpm2-with-pin=yes" is optional:
# https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#--tpm2-with-pin=BOOL
#
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=7 --tpm2-with-pin=yes /dev/sda3
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=7 --tpm2-with-pin=yes /dev/sda4
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=7 --tpm2-with-pin=yes /dev/sdb3
systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=7 --tpm2-with-pin=yes /dev/sdb4
# etc.
```

Reboot your system!

### 12.3.1.b) clevis

!!! info "System Requirement: Tang Server"

    This section requires a [tang server](https://github.com/latchset/tang) to preexist and be reachable from this system. A [simple tang server setup](https://www.youtube.com/watch?v=y_9_iWNUBug) is shown by RedHat on YouTube. I personally use AlmaLinux as tang server, but any [supported system](https://github.com/latchset/tang#getting-started) can do.

If you don't have a DHCP server available to the new system, add [the following network settings](https://www.systutorials.com/docs/linux/man/7-dracut.cmdline/#lbAN) to the "CMDLINE" array variable in `/etc/dracut.conf`:

```
ip=192.168.10.2::192.168.10.1:255.255.255.0:micro:enp1s0:off
```

Install "dev-vcs/git":

```shell
echo 'dev-vcs/git -webdav' >> /etc/portage/package.use/main && \
emerge -at dev-vcs/git
```

Install "app-crypt/clevis":

```shell
echo "app-crypt/clevis ~amd64
dev-libs/jose ~amd64
dev-libs/luksmeta ~amd64
app-crypt/tpm2-tools ~amd64" >> /etc/portage/package.accept_keywords/main && \
emerge -at app-crypt/clevis
```

Make sure that the PCRs you are going to use have a valid hash and don't consist of zeroes only:

```shell
tpm2_pcrread sha256
```

Bind all swap and system LUKS volumes.

```shell
# I only use PCR7 as recommended in the first sentence after following table:
# https://www.freedesktop.org/software/systemd/man/systemd-cryptenroll.html#id-1.7.3.10.2.2
#
clevis luks bind -d /dev/sda3 sss '{"t": 2, "pins": {"tpm2": {"pcr_bank":"sha256","pcr_ids":"7"}, "tang": {"url": "http://tang.local"}}}'
clevis luks bind -d /dev/sda4 sss '{"t": 2, "pins": {"tpm2": {"pcr_bank":"sha256","pcr_ids":"7"}, "tang": {"url": "http://tang.local"}}}'
clevis luks bind -d /dev/sdb3 sss '{"t": 2, "pins": {"tpm2": {"pcr_bank":"sha256","pcr_ids":"7"}, "tang": {"url": "http://tang.local"}}}'
clevis luks bind -d /dev/sdb4 sss '{"t": 2, "pins": {"tpm2": {"pcr_bank":"sha256","pcr_ids":"7"}, "tang": {"url": "http://tang.local"}}}'
# etc.
```

Show results:

```shell
clevis luks list -d /dev/sda3
clevis luks list -d /dev/sda4
clevis luks list -d /dev/sdb3
clevis luks list -d /dev/sdb4
# etc.
```

### 12.3.2. Kernel Rebuild

Rebuild the unified kernel image to contain the changes for measured boot:

```shell
emerge -at --oneshot \
$(qlist -eI sys-kernel/gentoo-kernel-bin >/dev/null && echo sys-kernel/gentoo-kernel-bin) \
$(qlist -eI sys-kernel/gentoo-kernel >/dev/null && echo sys-kernel/gentoo-kernel)
```

## 12.4. Package Cleanup

Update packages and remove extraneous ones (copy&paste one after the other):

```shell
emerge -atuDN @world
emerge --depclean -a
```
